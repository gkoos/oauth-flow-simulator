openapi: 3.0.3
info:
  title: OAuth Flow Simulator Management API
  version: 1.0.0
  description: API for managing users and clients (with per-client scopes) at runtime.
servers:
  - url: http://localhost:4000
paths:
  /sim/users:
    get:
      summary: List all users
      operationId: listUsers
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      summary: Create a new user
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '409':
          description: Conflict - user already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/users/{username}:
    get:
      summary: Get a user by username
      operationId: getUser
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    put:
      summary: Update a user
      operationId: updateUser
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                scopes:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    delete:
      summary: Delete a user
      operationId: deleteUser
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User deleted
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/clients:
    get:
      summary: List all clients
      operationId: listClients
      responses:
        '200':
          description: List of clients
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Client'
    post:
      summary: Create a new client
      operationId: createClient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientInput'
      responses:
        '201':
          description: Client created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '409':
          description: Conflict - client already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/clients/{clientId}:
    get:
      summary: Get a client by clientId
      operationId: getClient
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Client found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    put:
      summary: Update a client
      operationId: updateClient
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                clientSecret:
                  type: string
                redirectUris:
                  type: array
                  items:
                    type: string
                scopes:
                  type: array
                  items:
                    $ref: '#/components/schemas/ClientScope'
                refreshTokenLifetime:
                  type: integer
                  description: Lifetime of refresh tokens in milliseconds. If 0 or omitted, no expiry.
      responses:
        '200':
          description: Client updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    delete:
      summary: Delete a client
      operationId: deleteClient
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Client deleted
        '404':
          description: Client not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /revoke:
    post:
      summary: OAuth2 Token Revocation Endpoint
      description: |
        Revokes an access token or refresh token as per RFC 7009. Requires client authentication via HTTP Basic Auth or by including client_id and client_secret in the request body. Both methods are supported, but only HTTP Basic Auth is formally documented in OpenAPI security schemes.
      tags:
        - OAuth2
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: The token to revoke (access or refresh token).
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
                  description: Optional hint about the type of the token submitted for revocation.
                client_id:
                  type: string
                  description: Client ID (if not using HTTP Basic Auth).
                client_secret:
                  type: string
                  description: Client secret (if not using HTTP Basic Auth).
              required:
                - token
      responses:
        '200':
          description: Token revoked (or token not found). Always returns 200 OK per RFC 7009.
          content:
            application/json:
              schema:
                type: object
                description: Empty object.
      security:
        - basicAuth: []
  /introspect:
    post:
      summary: OAuth2 Token Introspection Endpoint
      description: |
        Returns metadata about an access token or refresh token as per RFC 7662. Requires client authentication via HTTP Basic Auth or by including client_id and client_secret in the request body. Both methods are supported, but only HTTP Basic Auth is formally documented in OpenAPI security schemes.
      tags:
        - OAuth2
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: The token to introspect (access or refresh token).
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
                  description: Optional hint about the type of the token submitted for introspection.
                client_id:
                  type: string
                  description: Client ID (if not using HTTP Basic Auth).
                client_secret:
                  type: string
                  description: Client secret (if not using HTTP Basic Auth).
              required:
                - token
      responses:
        '200':
          description: RFC 7662-compliant token introspection response
          content:
            application/json:
              schema:
                type: object
                properties:
                  active:
                    type: boolean
                    description: Whether the token is active (not expired or revoked).
                  scope:
                    type: string
                    description: Space-separated list of scopes granted to the token.
                  client_id:
                    type: string
                    description: Client identifier for the token.
                  username:
                    type: string
                    description: Username of the resource owner.
                  exp:
                    type: integer
                    description: Expiry time (seconds since epoch).
                  iat:
                    type: integer
                    description: Issued-at time (seconds since epoch).
                  sub:
                    type: string
                    description: Subject of the token (usually username).
                  aud:
                    type: string
                    description: Audience for the token (usually client_id).
                  iss:
                    type: string
                    description: Issuer identifier.
                  token_type:
                    type: string
                    enum: [access_token, refresh_token]
                    description: Type of the token introspected.
      security:
        - basicAuth: []
  /sim/config/jwt:
    get:
      summary: Get all JWT claims configuration
      operationId: getAllJWTClaims
      responses:
        '200':
          description: All JWT claims (globals, clients, users)
          content:
            application/json:
              schema:
                type: object
                properties:
                  globals:
                    type: object
                  clients:
                    type: object
                  users:
                    type: object
    post:
      summary: Update global JWT claims configuration
      operationId: updateGlobalJWTClaims
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                globals:
                  type: object
      responses:
        '200':
          description: Updated global JWT claims
          content:
            application/json:
              schema:
                type: object
                properties:
                  globals:
                    type: object
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/config/jwt/clients/{clientId}:
    post:
      summary: Update JWT claims for a client
      operationId: updateClientJWTClaims
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                claims:
                  type: object
      responses:
        '200':
          description: Updated JWT claims for client
          content:
            application/json:
              schema:
                type: object
                properties:
                  claims:
                    type: object
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/config/jwt/users/{userName}:
    post:
      summary: Update JWT claims for a user
      operationId: updateUserJWTClaims
      parameters:
        - in: path
          name: userName
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                claims:
                  type: object
      responses:
        '200':
          description: Updated JWT claims for user
          content:
            application/json:
              schema:
                type: object
                properties:
                  claims:
                    type: object
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /sim/sessions:
    get:
      summary: List all active sessions
      operationId: listSessions
      responses:
        '200':
          description: List of sessions (tokens, auth codes, refresh tokens)
          content:
            application/json:
              schema:
                type: object
                properties:
                  tokens:
                    type: object
                  authCodes:
                    type: object
                  refreshTokens:
                    type: object
  /sim/config/errors:
    get:
      summary: Get all active error simulation objects
      operationId: getErrorSimulations
      tags:
        - Error Simulation
      responses:
        '200':
          description: List of error simulation objects
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/ErrorSimulation'
    post:
      summary: Set or update an error simulation for a target
      operationId: setErrorSimulation
      tags:
        - Error Simulation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorSimulationInput'
      responses:
        '200':
          description: Error simulation set
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/ErrorSimulation'
    delete:
      summary: Delete error simulation(s)
      operationId: deleteErrorSimulation
      tags:
        - Error Simulation
      parameters:
        - in: query
          name: target
          required: false
          schema:
            type: string
            description: Target endpoint (e.g. '/token' or 'all')
      responses:
        '200':
          description: Error simulation(s) deleted
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/ErrorSimulation'
  /sim/config/delays:
    get:
      summary: Get all active delay simulation objects
      operationId: getDelaySimulations
      tags:
        - Delay Simulation
      responses:
        '200':
          description: List of delay simulation objects
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/DelaySimulation'
    post:
      summary: Set or update a delay simulation for a target
      operationId: setDelaySimulation
      tags:
        - Delay Simulation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DelaySimulationInput'
      responses:
        '200':
          description: Delay simulation set
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/DelaySimulation'
    delete:
      summary: Delete delay simulation(s)
      operationId: deleteDelaySimulation
      tags:
        - Delay Simulation
      parameters:
        - in: query
          name: target
          required: false
          schema:
            type: string
            description: Target endpoint (e.g. '/token' or 'all')
      responses:
        '200':
          description: Delay simulation(s) deleted
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/DelaySimulation'
components:
  schemas:
    User:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
    UserInput:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
    Client:
      type: object
      required: [clientId, clientSecret, redirectUris, scopes]
      properties:
        clientId:
          type: string
        clientSecret:
          type: string
        redirectUris:
          type: array
          items:
            type: string
        scopes:
          type: array
          items:
            $ref: '#/components/schemas/ClientScope'
        refreshTokenLifetime:
          type: integer
          description: Lifetime of refresh tokens in milliseconds. If 0 or omitted, no expiry.
    ClientInput:
      type: object
      required: [clientId, clientSecret, redirectUris, scopes]
      properties:
        clientId:
          type: string
        clientSecret:
          type: string
        redirectUris:
          type: array
          items:
            type: string
        scopes:
          type: array
          items:
            $ref: '#/components/schemas/ClientScope'
        refreshTokenLifetime:
          type: integer
          description: Lifetime of refresh tokens in milliseconds. If 0 or omitted, no expiry.
    ClientScope:
      type: object
      required: [name, description, consentNeeded]
      properties:
        name:
          type: string
        description:
          type: string
        consentNeeded:
          type: boolean
    ErrorSimulation:
      type: object
      properties:
        status:
          type: integer
        error:
          type: string
        error_description:
          type: string
    ErrorSimulationInput:
      type: object
      required:
        - target
        - status
        - error
      properties:
        target:
          type: string
          description: Target endpoint (e.g. '/token' or 'all')
        status:
          type: integer
        error:
          type: string
        error_description:
          type: string
    DelaySimulation:
      type: object
      properties:
        delay:
          type: integer
          description: Delay in milliseconds
    DelaySimulationInput:
      type: object
      required:
        - target
        - delay
      properties:
        target:
          type: string
          description: Target endpoint (e.g. '/token' or 'all')
        delay:
          type: integer
          description: Delay in milliseconds
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
